"use strict";(globalThis.webpackChunkdocuments=globalThis.webpackChunkdocuments||[]).push([[8153],{14962:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>s,contentTitle:()=>c,default:()=>x,frontMatter:()=>l,metadata:()=>o,toc:()=>a});const o=JSON.parse('{"id":"project-knowledge/ateliers-ai-mcp/content/McpContext/USAGE","title":"MCP \u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u4f7f\u7528\u65b9\u6cd5","description":"\u6982\u8981","source":"@site/docs/project-knowledge/ateliers-ai-mcp/content/McpContext/USAGE.md","sourceDirName":"project-knowledge/ateliers-ai-mcp/content/McpContext","slug":"/project-knowledge/ateliers-ai-mcp/content/McpContext/USAGE","permalink":"/docs/project-knowledge/ateliers-ai-mcp/content/McpContext/USAGE","draft":false,"unlisted":false,"editUrl":"https://github.com/yuu-git/ateliers-dev/edit/master/docs/project-knowledge/ateliers-ai-mcp/content/McpContext/USAGE.md","tags":[],"version":"current","frontMatter":{}}');var i=t(74848),r=t(28453);const l={},c="MCP \u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u4f7f\u7528\u65b9\u6cd5",s={},a=[{value:"\u6982\u8981",id:"\u6982\u8981",level:2},{value:"\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9",id:"\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9",level:2},{value:"1. DI \u30b3\u30f3\u30c6\u30ca\u3078\u306e\u767b\u9332",id:"1-di-\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u767b\u9332",level:3},{value:"2. \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3",id:"2-\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3",level:3},{value:"\u30b9\u30b3\u30fc\u30d7\u306e\u7ba1\u7406",id:"\u30b9\u30b3\u30fc\u30d7\u306e\u7ba1\u7406",level:2},{value:"\u30c4\u30fc\u30eb\u30b9\u30b3\u30fc\u30d7",id:"\u30c4\u30fc\u30eb\u30b9\u30b3\u30fc\u30d7",level:3},{value:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7",id:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7",level:3},{value:"\u76f8\u95a2ID\u306e\u6d3b\u7528",id:"\u76f8\u95a2id\u306e\u6d3b\u7528",level:2},{value:"\u30ed\u30b0\u3068\u306e\u7d71\u5408",id:"\u30ed\u30b0\u3068\u306e\u7d71\u5408",level:3},{value:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u3078\u306e\u8ffd\u52a0",id:"http\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u3078\u306e\u8ffd\u52a0",level:3},{value:"\u8907\u6570\u30c4\u30fc\u30eb\u306e\u5b9f\u884c",id:"\u8907\u6570\u30c4\u30fc\u30eb\u306e\u5b9f\u884c",level:2},{value:"\u9806\u6b21\u5b9f\u884c",id:"\u9806\u6b21\u5b9f\u884c",level:3},{value:"\u4e26\u5217\u5b9f\u884c",id:"\u4e26\u5217\u5b9f\u884c",level:3},{value:"\u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u53d6\u5f97",id:"\u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u53d6\u5f97",level:2},{value:"\u9759\u7684\u30a2\u30af\u30bb\u30b9",id:"\u9759\u7684\u30a2\u30af\u30bb\u30b9",level:3},{value:"DI \u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\uff08\u63a8\u5968\uff09",id:"di-\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u63a8\u5968",level:3},{value:"\u30c6\u30b9\u30c8\u3067\u306e\u4f7f\u7528\u4f8b",id:"\u30c6\u30b9\u30c8\u3067\u306e\u4f7f\u7528\u4f8b",level:2},{value:"\u57fa\u672c\u7684\u306a\u30c6\u30b9\u30c8",id:"\u57fa\u672c\u7684\u306a\u30c6\u30b9\u30c8",level:3},{value:"\u7d71\u5408\u30c6\u30b9\u30c8",id:"\u7d71\u5408\u30c6\u30b9\u30c8",level:3},{value:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",level:2},{value:"\u9ad8\u5ea6\u306a\u4f7f\u7528\u4f8b",id:"\u9ad8\u5ea6\u306a\u4f7f\u7528\u4f8b",level:2},{value:"\u30ab\u30b9\u30bf\u30e0\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u8ffd\u52a0",id:"\u30ab\u30b9\u30bf\u30e0\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u8ffd\u52a0",level:3},{value:"\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3068\u306e\u7d71\u5408\uff08ASP.NET Core\uff09",id:"\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3068\u306e\u7d71\u5408aspnet-core",level:3},{value:"\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",id:"\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",level:2},{value:"\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c null \u306e\u5834\u5408",id:"\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c-null-\u306e\u5834\u5408",level:3},{value:"\u76f8\u95a2ID\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408",id:"\u76f8\u95a2id\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408",level:3},{value:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408",id:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408",level:3},{value:"\u53c2\u8003\u30ea\u30f3\u30af",id:"\u53c2\u8003\u30ea\u30f3\u30af",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.header,{children:(0,i.jsx)(e.h1,{id:"mcp-\u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u4f7f\u7528\u65b9\u6cd5",children:"MCP \u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u4f7f\u7528\u65b9\u6cd5"})}),"\n",(0,i.jsx)(e.h2,{id:"\u6982\u8981",children:"\u6982\u8981"}),"\n",(0,i.jsx)(e.p,{children:"MCP \u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306f\u3001\u30c4\u30fc\u30eb\u306e\u5b9f\u884c\u3092\u8ffd\u8de1\u3059\u308b\u305f\u3081\u306e\u4ed5\u7d44\u307f\u3067\u3059\u3002\n\u5404\u30c4\u30fc\u30eb\u306e\u5b9f\u884c\u306b\u306f\u4e00\u610f\u306e\u76f8\u95a2ID\uff08CorrelationId\uff09\u304c\u5272\u308a\u5f53\u3066\u3089\u308c\u3001\u30c4\u30fc\u30eb\u540d\u3068\u5171\u306b\u7ba1\u7406\u3055\u308c\u307e\u3059\u3002"}),"\n",(0,i.jsx)(e.h2,{id:"\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9",children:"\u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9"}),"\n",(0,i.jsx)(e.h3,{id:"1-di-\u30b3\u30f3\u30c6\u30ca\u3078\u306e\u767b\u9332",children:"1. DI \u30b3\u30f3\u30c6\u30ca\u3078\u306e\u767b\u9332"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:"using Ateliers.Ai.Mcp.DependencyInjection;\nusing Microsoft.Extensions.DependencyInjection;\n\nvar services = new ServiceCollection();\n\n// MCP \u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u767b\u9332\nservices.AddMcpExecutionContext();\n\nvar serviceProvider = services.BuildServiceProvider();\n"})}),"\n",(0,i.jsx)(e.h3,{id:"2-\u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3",children:"2. \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'using Ateliers.Ai.Mcp;\nusing Ateliers.Ai.Mcp.Context;\n\npublic class MyMcpTool\n{\n    private readonly IMcpExecutionContext _context;\n\n    public MyMcpTool(IMcpExecutionContext context)\n    {\n        _context = context;\n    }\n\n    public async Task ExecuteAsync()\n    {\n        // \u30c4\u30fc\u30eb\u30b9\u30b3\u30fc\u30d7\u3092\u958b\u59cb\n        using var scope = _context.BeginTool("my.tool");\n        \n        // \u76f8\u95a2ID\u3068\u30c4\u30fc\u30eb\u540d\u304c\u81ea\u52d5\u8a2d\u5b9a\u3055\u308c\u308b\n        Console.WriteLine($"CorrelationId: {_context.CorrelationId}");\n        Console.WriteLine($"ToolName: {_context.ToolName}");\n        \n        // \u30c4\u30fc\u30eb\u51e6\u7406\n        await ProcessAsync();\n    }\n    \n    private async Task ProcessAsync()\n    {\n        // \u3053\u306e\u30e1\u30bd\u30c3\u30c9\u5185\u3067\u3082\u540c\u3058\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c\u5229\u7528\u53ef\u80fd\n        Console.WriteLine($"Still in context: {_context.CorrelationId}");\n        await Task.Delay(100);\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u30b9\u30b3\u30fc\u30d7\u306e\u7ba1\u7406",children:"\u30b9\u30b3\u30fc\u30d7\u306e\u7ba1\u7406"}),"\n",(0,i.jsx)(e.h3,{id:"\u30c4\u30fc\u30eb\u30b9\u30b3\u30fc\u30d7",children:"\u30c4\u30fc\u30eb\u30b9\u30b3\u30fc\u30d7"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public async Task ExecuteToolAsync()\n{\n    // using \u30b9\u30c6\u30fc\u30c8\u30e1\u30f3\u30c8\u3067\u30b9\u30b3\u30fc\u30d7\u3092\u7ba1\u7406\n    using var scope = _context.BeginTool("notion.sync");\n    \n    // \u30b9\u30b3\u30fc\u30d7\u5185\u306e\u51e6\u7406\n    await SyncNotionAsync();\n    \n    // \u30b9\u30b3\u30fc\u30d7\u7d42\u4e86\u6642\u306b\u81ea\u52d5\u7684\u306b\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7",children:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public async Task ParentToolAsync()\n{\n    using var parentScope = _context.BeginTool("parent.tool");\n    Console.WriteLine($"Parent CorrelationId: {_context.CorrelationId}");\n    Console.WriteLine($"Parent ToolName: {_context.ToolName}");\n    \n    // \u5b50\u30c4\u30fc\u30eb\u3092\u547c\u3073\u51fa\u3057\n    await ChildToolAsync();\n    \n    // \u89aa\u30b9\u30b3\u30fc\u30d7\u306b\u623b\u308b\n    Console.WriteLine($"Back to parent: {_context.CorrelationId}");\n}\n\nprivate async Task ChildToolAsync()\n{\n    using var childScope = _context.BeginTool("child.tool");\n    Console.WriteLine($"Child CorrelationId: {_context.CorrelationId}");\n    Console.WriteLine($"Child ToolName: {_context.ToolName}");\n    \n    await Task.Delay(100);\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u76f8\u95a2id\u306e\u6d3b\u7528",children:"\u76f8\u95a2ID\u306e\u6d3b\u7528"}),"\n",(0,i.jsx)(e.h3,{id:"\u30ed\u30b0\u3068\u306e\u7d71\u5408",children:"\u30ed\u30b0\u3068\u306e\u7d71\u5408"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class NotionSyncTool\n{\n    private readonly IMcpExecutionContext _context;\n    private readonly IMcpLogger _logger;\n\n    public NotionSyncTool(IMcpExecutionContext context, IMcpLogger logger)\n    {\n        _context = context;\n        _logger = logger;\n    }\n\n    public async Task ExecuteAsync()\n    {\n        using var scope = _context.BeginTool("notion.sync");\n        \n        // \u30ed\u30b0\u306b\u81ea\u52d5\u7684\u306b\u76f8\u95a2ID\u3068\u30c4\u30fc\u30eb\u540d\u304c\u4ed8\u4e0e\u3055\u308c\u308b\n        _logger.Info("MCP.Start");  // [CID:abc-123] [Tool:notion.sync] MCP.Start\n        \n        try\n        {\n            await SyncAsync();\n            _logger.Info("MCP.Success");\n        }\n        catch (Exception ex)\n        {\n            _logger.Error("MCP.Failed", ex);\n            throw;\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"http\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u3078\u306e\u8ffd\u52a0",children:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\u30d8\u30c3\u30c0\u30fc\u3078\u306e\u8ffd\u52a0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class ApiClient\n{\n    private readonly IMcpExecutionContext _context;\n    private readonly HttpClient _httpClient;\n\n    public ApiClient(IMcpExecutionContext context, HttpClient httpClient)\n    {\n        _context = context;\n        _httpClient = httpClient;\n    }\n\n    public async Task<string> GetDataAsync(string url)\n    {\n        var request = new HttpRequestMessage(HttpMethod.Get, url);\n        \n        // \u76f8\u95a2ID\u3092\u30d8\u30c3\u30c0\u30fc\u306b\u8ffd\u52a0\uff08\u5206\u6563\u30c8\u30ec\u30fc\u30b7\u30f3\u30b0\uff09\n        if (!string.IsNullOrEmpty(_context.CorrelationId))\n        {\n            request.Headers.Add("X-Correlation-Id", _context.CorrelationId);\n        }\n        \n        var response = await _httpClient.SendAsync(request);\n        return await response.Content.ReadAsStringAsync();\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u8907\u6570\u30c4\u30fc\u30eb\u306e\u5b9f\u884c",children:"\u8907\u6570\u30c4\u30fc\u30eb\u306e\u5b9f\u884c"}),"\n",(0,i.jsx)(e.h3,{id:"\u9806\u6b21\u5b9f\u884c",children:"\u9806\u6b21\u5b9f\u884c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public async Task ExecuteMultipleToolsAsync()\n{\n    // \u30c4\u30fc\u30eb1\n    using (var scope1 = _context.BeginTool("tool1"))\n    {\n        _logger.Info("Executing tool1");\n        await Task.Delay(100);\n    }\n    \n    // \u30c4\u30fc\u30eb2\n    using (var scope2 = _context.BeginTool("tool2"))\n    {\n        _logger.Info("Executing tool2");\n        await Task.Delay(100);\n    }\n    \n    // \u5404\u30c4\u30fc\u30eb\u306f\u72ec\u7acb\u3057\u305f\u76f8\u95a2ID\u3092\u6301\u3064\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u4e26\u5217\u5b9f\u884c",children:"\u4e26\u5217\u5b9f\u884c"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public async Task ExecuteToolsInParallelAsync()\n{\n    var tasks = new[]\n    {\n        ExecuteToolAsync("tool1"),\n        ExecuteToolAsync("tool2"),\n        ExecuteToolAsync("tool3")\n    };\n    \n    await Task.WhenAll(tasks);\n}\n\nprivate async Task ExecuteToolAsync(string toolName)\n{\n    // \u5404\u30bf\u30b9\u30af\u3067\u72ec\u7acb\u3057\u305f\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u6301\u3064\n    using var scope = _context.BeginTool(toolName);\n    _logger.Info($"Executing {toolName}");\n    await Task.Delay(100);\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u53d6\u5f97",children:"\u5b9f\u884c\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u306e\u53d6\u5f97"}),"\n",(0,i.jsx)(e.h3,{id:"\u9759\u7684\u30a2\u30af\u30bb\u30b9",children:"\u9759\u7684\u30a2\u30af\u30bb\u30b9"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'using Ateliers.Ai.Mcp.Context;\n\npublic class MyService\n{\n    public void DoSomething()\n    {\n        // \u9759\u7684\u30d7\u30ed\u30d1\u30c6\u30a3\u304b\u3089\u73fe\u5728\u306e\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u53d6\u5f97\n        var current = McpExecutionContext.Current;\n        if (current != null)\n        {\n            Console.WriteLine($"CorrelationId: {current.CorrelationId}");\n            Console.WriteLine($"ToolName: {current.ToolName}");\n        }\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"di-\u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\u63a8\u5968",children:"DI \u7d4c\u7531\u3067\u306e\u30a2\u30af\u30bb\u30b9\uff08\u63a8\u5968\uff09"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class MyService\n{\n    private readonly IMcpExecutionContext _context;\n\n    // \u30b3\u30f3\u30b9\u30c8\u30e9\u30af\u30bf\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\uff08\u63a8\u5968\uff09\n    public MyService(IMcpExecutionContext context)\n    {\n        _context = context;\n    }\n\n    public void DoSomething()\n    {\n        Console.WriteLine($"CorrelationId: {_context.CorrelationId}");\n        Console.WriteLine($"ToolName: {_context.ToolName}");\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u30c6\u30b9\u30c8\u3067\u306e\u4f7f\u7528\u4f8b",children:"\u30c6\u30b9\u30c8\u3067\u306e\u4f7f\u7528\u4f8b"}),"\n",(0,i.jsx)(e.h3,{id:"\u57fa\u672c\u7684\u306a\u30c6\u30b9\u30c8",children:"\u57fa\u672c\u7684\u306a\u30c6\u30b9\u30c8"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'using Ateliers.Ai.Mcp;\nusing Ateliers.Ai.Mcp.Context;\nusing Microsoft.Extensions.DependencyInjection;\nusing Xunit;\n\npublic class McpExecutionContextTests\n{\n    [Fact]\n    public void Test_ContextScope()\n    {\n        // Arrange\n        var services = new ServiceCollection();\n        services.AddMcpExecutionContext();\n        var provider = services.BuildServiceProvider();\n        var context = provider.GetRequiredService<IMcpExecutionContext>();\n        \n        // Act\n        string? correlationId = null;\n        string? toolName = null;\n        \n        using (var scope = context.BeginTool("test.tool"))\n        {\n            correlationId = context.CorrelationId;\n            toolName = context.ToolName;\n        }\n        \n        // Assert\n        Assert.NotNull(correlationId);\n        Assert.Equal("test.tool", toolName);\n    }\n\n    [Fact]\n    public void Test_NestedScopes()\n    {\n        // Arrange\n        var services = new ServiceCollection();\n        services.AddMcpExecutionContext();\n        var provider = services.BuildServiceProvider();\n        var context = provider.GetRequiredService<IMcpExecutionContext>();\n        \n        // Act & Assert\n        using (var parentScope = context.BeginTool("parent.tool"))\n        {\n            var parentCorrelationId = context.CorrelationId;\n            var parentToolName = context.ToolName;\n            \n            Assert.Equal("parent.tool", parentToolName);\n            \n            using (var childScope = context.BeginTool("child.tool"))\n            {\n                var childCorrelationId = context.CorrelationId;\n                var childToolName = context.ToolName;\n                \n                Assert.Equal("child.tool", childToolName);\n                Assert.NotEqual(parentCorrelationId, childCorrelationId);\n            }\n            \n            // \u89aa\u30b9\u30b3\u30fc\u30d7\u306b\u623b\u308b\n            Assert.Equal(parentCorrelationId, context.CorrelationId);\n            Assert.Equal("parent.tool", context.ToolName);\n        }\n    }\n\n    [Fact]\n    public async Task Test_StaticAccess()\n    {\n        // Arrange\n        var services = new ServiceCollection();\n        services.AddMcpExecutionContext();\n        var provider = services.BuildServiceProvider();\n        var context = provider.GetRequiredService<IMcpExecutionContext>();\n        \n        // Act\n        using var scope = context.BeginTool("test.tool");\n        \n        // \u9759\u7684\u30d7\u30ed\u30d1\u30c6\u30a3\u304b\u3089\u30a2\u30af\u30bb\u30b9\n        var current = McpExecutionContext.Current;\n        \n        // Assert\n        Assert.NotNull(current);\n        Assert.Equal(context.CorrelationId, current.CorrelationId);\n        Assert.Equal("test.tool", current.ToolName);\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u7d71\u5408\u30c6\u30b9\u30c8",children:"\u7d71\u5408\u30c6\u30b9\u30c8"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class NotionSyncToolIntegrationTests\n{\n    [Fact]\n    public async Task Test_ToolExecutionWithContext()\n    {\n        // Arrange\n        var services = new ServiceCollection();\n        services.AddMcpExecutionContext();\n        \n        InMemoryMcpLogger memoryLogger = null!;\n        services.AddMcpLogging(logging =>\n        {\n            logging.AddInMemory(out memoryLogger);\n        });\n        \n        var provider = services.BuildServiceProvider();\n        var tool = new NotionSyncTool(\n            provider.GetRequiredService<IMcpExecutionContext>(),\n            provider.GetRequiredService<IMcpLogger>());\n        \n        // Act\n        await tool.ExecuteAsync();\n        \n        // Assert\n        Assert.All(memoryLogger.Entries, entry =>\n        {\n            Assert.NotNull(entry.CorrelationId);\n            Assert.Equal("notion.sync", entry.ToolName);\n            Assert.Equal("MCP", entry.Category);\n        });\n    }\n}\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9",children:"\u30d9\u30b9\u30c8\u30d7\u30e9\u30af\u30c6\u30a3\u30b9"}),"\n",(0,i.jsxs)(e.ol,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u5fc5\u305a using \u30b9\u30c6\u30fc\u30c8\u30e1\u30f3\u30c8\u3092\u4f7f\u7528\u3059\u308b"}),": \u30b9\u30b3\u30fc\u30d7\u306e\u9069\u5207\u306a\u7ba1\u7406"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"DI \u3067\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u3092\u6ce8\u5165\u3059\u308b"}),": \u9759\u7684\u30a2\u30af\u30bb\u30b9\u3088\u308a\u3082\u63a8\u5968"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u30b9\u30b3\u30fc\u30d7\u306f\u77ed\u304f\u4fdd\u3064"}),": \u30c4\u30fc\u30eb\u306e\u5b9f\u884c\u5358\u4f4d\u3067\u30b9\u30b3\u30fc\u30d7\u3092\u4f5c\u6210"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u76f8\u95a2ID\u3092\u30ed\u30b0\u306b\u6d3b\u7528\u3059\u308b"}),": \u30c8\u30ec\u30fc\u30b5\u30d3\u30ea\u30c6\u30a3\u306e\u5411\u4e0a"]}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.strong,{children:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7\u3092\u6d3b\u7528\u3059\u308b"}),": \u8907\u96d1\u306a\u51e6\u7406\u306e\u968e\u5c64\u7ba1\u7406"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"\u9ad8\u5ea6\u306a\u4f7f\u7528\u4f8b",children:"\u9ad8\u5ea6\u306a\u4f7f\u7528\u4f8b"}),"\n",(0,i.jsx)(e.h3,{id:"\u30ab\u30b9\u30bf\u30e0\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u8ffd\u52a0",children:"\u30ab\u30b9\u30bf\u30e0\u30d7\u30ed\u30d1\u30c6\u30a3\u306e\u8ffd\u52a0"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class ExtendedMcpExecutionContext : McpExecutionContext\n{\n    public string? UserId { get; init; }\n    public string? SessionId { get; init; }\n\n    public ExtendedMcpExecutionContext(\n        string correlationId,\n        string? toolName,\n        string? userId = null,\n        string? sessionId = null)\n        : base(correlationId, toolName)\n    {\n        UserId = userId;\n        SessionId = sessionId;\n    }\n}\n\n// DI \u767b\u9332\nservices.AddScoped<IMcpExecutionContext>(provider =>\n    new ExtendedMcpExecutionContext(\n        Guid.NewGuid().ToString(),\n        null,\n        userId: "user123",\n        sessionId: "session456"));\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3068\u306e\u7d71\u5408aspnet-core",children:"\u30df\u30c9\u30eb\u30a6\u30a7\u30a2\u3068\u306e\u7d71\u5408\uff08ASP.NET Core\uff09"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'public class McpContextMiddleware\n{\n    private readonly RequestDelegate _next;\n\n    public McpContextMiddleware(RequestDelegate next)\n    {\n        _next = next;\n    }\n\n    public async Task InvokeAsync(HttpContext context)\n    {\n        var mcpContext = context.RequestServices\n            .GetRequiredService<IMcpExecutionContext>();\n\n        // HTTP\u30d8\u30c3\u30c0\u30fc\u304b\u3089\u76f8\u95a2ID\u3092\u53d6\u5f97\uff08\u5b58\u5728\u3059\u308b\u5834\u5408\uff09\n        var correlationId = context.Request.Headers["X-Correlation-Id"].FirstOrDefault()\n            ?? Guid.NewGuid().ToString();\n\n        using var scope = mcpContext.BeginTool(context.Request.Path);\n        \n        // \u30ec\u30b9\u30dd\u30f3\u30b9\u30d8\u30c3\u30c0\u30fc\u306b\u76f8\u95a2ID\u3092\u8ffd\u52a0\n        context.Response.Headers.Append("X-Correlation-Id", correlationId);\n\n        await _next(context);\n    }\n}\n\n// Startup.cs\napp.UseMiddleware<McpContextMiddleware>();\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",children:"\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0"}),"\n",(0,i.jsx)(e.h3,{id:"\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c-null-\u306e\u5834\u5408",children:"\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c null \u306e\u5834\u5408"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'// AddMcpExecutionContext \u304c\u767b\u9332\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\nservices.AddMcpExecutionContext();\n\n// \u30b9\u30b3\u30fc\u30d7\u304c\u4f5c\u6210\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\nusing var scope = context.BeginTool("tool.name");\n'})}),"\n",(0,i.jsx)(e.h3,{id:"\u76f8\u95a2id\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408",children:"\u76f8\u95a2ID\u304c\u4e00\u81f4\u3057\u306a\u3044\u5834\u5408"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:"// \u975e\u540c\u671f\u51e6\u7406\u3067 ExecutionContext \u304c\u5f15\u304d\u7d99\u304c\u308c\u306a\u3044\u5834\u5408\n// ConfigureAwait(false) \u3092\u4f7f\u7528\u3057\u3066\u3044\u306a\u3044\u304b\u78ba\u8a8d\nawait Task.Delay(100); // OK\nawait Task.Delay(100).ConfigureAwait(false); // NG: \u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u304c\u5931\u308f\u308c\u308b\n"})}),"\n",(0,i.jsx)(e.h3,{id:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408",children:"\u30cd\u30b9\u30c8\u3057\u305f\u30b9\u30b3\u30fc\u30d7\u304c\u3046\u307e\u304f\u52d5\u4f5c\u3057\u306a\u3044\u5834\u5408"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-csharp",children:'// using \u30b9\u30c6\u30fc\u30c8\u30e1\u30f3\u30c8\u3092\u6b63\u3057\u304f\u4f7f\u7528\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\nusing (var scope1 = context.BeginTool("tool1"))\n{\n    using (var scope2 = context.BeginTool("tool2"))\n    {\n        // OK\n    }\n}\n\n// \u4ee5\u4e0b\u306f NG: scope \u304c\u9069\u5207\u306b\u9589\u3058\u3089\u308c\u306a\u3044\nvar scope1 = context.BeginTool("tool1");\nvar scope2 = context.BeginTool("tool2");\n'})}),"\n",(0,i.jsx)(e.h2,{id:"\u53c2\u8003\u30ea\u30f3\u30af",children:"\u53c2\u8003\u30ea\u30f3\u30af"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"/docs/project-knowledge/ateliers-ai-mcp/content/logging/USAGE",children:"MCP Logging USAGE"})}),"\n",(0,i.jsx)(e.li,{children:(0,i.jsx)(e.a,{href:"../../../Ateliers.Core/Context/",children:"Ateliers.Core ExecutionContext"})}),"\n"]})]})}function x(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>l,x:()=>c});var o=t(96540);const i={},r=o.createContext(i);function l(n){const e=o.useContext(r);return o.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),o.createElement(r.Provider,{value:e},n.children)}}}]);